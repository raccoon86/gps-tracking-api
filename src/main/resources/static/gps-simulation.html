<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¤ì‹œê°„ GPS ì‹œë®¬ë ˆì´ì…˜ - ë§ˆë¼í†¤ ëŒ€íšŒ</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f8f9fa;
      }

      #map {
        height: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .control-panel {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .leaderboard {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .user-marker {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 3px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .user-1 {
        background-color: #ff4444;
      }
      .user-2 {
        background-color: #44ff44;
      }
      .user-3 {
        background-color: #4444ff;
      }
      .user-4 {
        background-color: #ffaa44;
      }
      .user-5 {
        background-color: #aa44ff;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .status-running {
        background-color: #28a745;
      }
      .status-stopped {
        background-color: #dc3545;
      }
      .status-paused {
        background-color: #ffc107;
      }

      .stats {
        font-size: 0.9em;
        color: #666;
      }

      .speed-control {
        margin: 10px 0;
      }

      .user-info {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid;
      }

      .user-info-1 {
        border-left-color: #ff4444;
      }
      .user-info-2 {
        border-left-color: #44ff44;
      }
      .user-info-3 {
        border-left-color: #4444ff;
      }
      .user-info-4 {
        border-left-color: #ffaa44;
      }
      .user-info-5 {
        border-left-color: #aa44ff;
      }

      .log-area {
        height: 200px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        font-family: monospace;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-3">
      <div class="row">
        <!-- ì§€ë„ ì˜ì—­ -->
        <div class="col-lg-8">
          <div class="control-panel">
            <h2 class="mb-3">ğŸƒâ€â™‚ï¸ ì‹¤ì‹œê°„ GPS ì‹œë®¬ë ˆì´ì…˜ - ë§ˆë¼í†¤ ëŒ€íšŒ</h2>

            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
            <div class="d-flex gap-2 mb-3">
              <button id="initBtn" class="btn btn-primary">
                ì‹œìŠ¤í…œ ì´ˆê¸°í™”
              </button>
              <button id="startBtn" class="btn btn-success">
                ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
              </button>
              <button id="pauseBtn" class="btn btn-warning">ì¼ì‹œì •ì§€</button>
              <button id="stopBtn" class="btn btn-danger">ì •ì§€</button>
              <button id="resetBtn" class="btn btn-secondary">ë¦¬ì…‹</button>
              <button id="stopBatchBtn" class="btn btn-outline-danger">
                ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì¤‘ì§€
              </button>
              <button id="startPeriodicFakeBtn" class="btn btn-outline-primary">
                â±ï¸ Fake GPS ì£¼ê¸°ì  ì „ì†¡ ì‹œì‘
              </button>
              <button id="stopPeriodicFakeBtn" class="btn btn-outline-danger">
                â¹ï¸ Fake GPS ì „ì†¡ ì¤‘ì§€
              </button>
            </div>

            <!-- ê°œë³„ ì„¤ì • ë²„íŠ¼ë“¤ -->
            <div class="d-flex gap-2 mb-3">
              <button id="createEventBtn" class="btn btn-outline-primary">
                ğŸ† ëŒ€íšŒ ìƒì„±
              </button>
              <button id="createCourseBtn" class="btn btn-outline-info">
                ğŸ›¤ï¸ ì½”ìŠ¤ ìƒì„±
              </button>
              <button id="createUsersBtn" class="btn btn-outline-success">
                ğŸ‘¥ ìœ ì € ìƒì„±
              </button>
              <button id="checkStatusBtn" class="btn btn-outline-secondary">
                ğŸ“Š ìƒíƒœ í™•ì¸
              </button>
            </div>

            <!-- ìƒˆë¡œìš´ GPS í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ -->
            <div class="d-flex gap-2 mb-3">
              <button id="generateFakeBtn" class="btn btn-info">
                ğŸ“± Fake GPS ë°ì´í„° ìƒì„±
              </button>
              <button id="batchTestBtn" class="btn btn-warning">
                ğŸš€ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ (ìœ ì €1)
              </button>
              <button id="allUsersBatchBtn" class="btn btn-success">
                ğŸƒâ€â™‚ï¸ ì „ì²´ ìœ ì € ë°°ì¹˜ í…ŒìŠ¤íŠ¸
              </button>
            </div>

            <!-- ì‹œë®¬ë ˆì´ì…˜ ì„¤ì • -->
            <div class="row">
              <div class="col-md-6">
                <label for="speedRange" class="form-label"
                  >ì‹œë®¬ë ˆì´ì…˜ ì†ë„</label
                >
                <input
                  type="range"
                  class="form-range"
                  id="speedRange"
                  min="1"
                  max="10"
                  value="3"
                />
                <span id="speedValue">3x</span>
              </div>
              <div class="col-md-6">
                <label for="errorRange" class="form-label">GPS ì˜¤ì°¨ ë²”ìœ„</label>
                <input
                  type="range"
                  class="form-range"
                  id="errorRange"
                  min="5"
                  max="50"
                  value="15"
                />
                <span id="errorValue">15m</span>
              </div>
            </div>
          </div>

          <!-- ì§€ë„ -->
          <div id="map"></div>
        </div>

        <!-- ì‚¬ì´ë“œë°” -->
        <div class="col-lg-4">
          <!-- ì‹¤ì‹œê°„ ìˆœìœ„ -->
          <div class="leaderboard mb-3">
            <h4 class="mb-3">ğŸ† ì‹¤ì‹œê°„ ìˆœìœ„</h4>
            <div id="leaderboard">
              <div class="text-center text-muted">
                ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•˜ë©´ ìˆœìœ„ê°€ í‘œì‹œë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>

          <!-- ì°¸ê°€ì ì •ë³´ -->
          <div class="leaderboard mb-3">
            <h4 class="mb-3">ğŸ‘¥ ì°¸ê°€ì í˜„í™©</h4>
            <div id="participantInfo">
              <!-- ì°¸ê°€ì ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
          </div>

          <!-- ë¡œê·¸ -->
          <div class="leaderboard">
            <h5 class="mb-3">ğŸ“Š ì‹œìŠ¤í…œ ë¡œê·¸</h5>
            <div id="logArea" class="log-area"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main JavaScript -->
    <script>
      // ì „ì—­ ë³€ìˆ˜
      let map;
      let gpxRoute;
      let userMarkers = {};
      let simulationRunning = false;
      let batchTestRunning = false;
      let simulationInterval;
      let currentPositions = {};
      let simulationSpeed = 3;
      let gpsErrorRange = 15;
      // ì£¼ê¸°ì  Fake GPS ì „ì†¡ ê´€ë ¨ ë³€ìˆ˜
      let periodicFakeGpsInterval = null;
      let periodicFakeGpsData = null;

      // API ì„¤ì •
      const API_BASE = "";
      const EVENT_ID = 1;
      const EVENT_DETAIL_ID = 100;

      // í…ŒìŠ¤íŠ¸ ìœ ì € ì •ë³´
      const TEST_USERS = [
        { userId: 1, name: "ê¹€ëŸ¬ë„ˆ", bibNumber: "A001", color: "#ff4444" },
        { userId: 2, name: "ì´ìŠ¤í”¼ë“œ", bibNumber: "A002", color: "#44ff44" },
        { userId: 3, name: "ë°•ë§ˆë¼í†¤", bibNumber: "A003", color: "#4444ff" },
        { userId: 4, name: "ìµœëŸ¬ë‹", bibNumber: "A004", color: "#ffaa44" },
        { userId: 5, name: "ì •íŠ¸ë™", bibNumber: "A005", color: "#aa44ff" },
      ];

      // GPX ê²½ë¡œ ë°ì´í„° (test_route.gpx ì¢Œí‘œë“¤)
      const GPX_POINTS = [
        [37.5413553485092, 127.115719020367],
        [37.5390881874808, 127.114029228687],
        [37.5379482005428, 127.113452553749],
        [37.5353682776934, 127.11048334837],
        [37.5351258071487, 127.110266089439],
        [37.5344154064531, 127.109783291817],
        [37.5337836971563, 127.109482884407],
        [37.5320799696497, 127.108764052391],
        [37.5317162475003, 127.108696997166],
        [37.5315503385624, 127.108699679375],
        [37.5301273352067, 127.107908427715],
        [37.5301188268838, 127.107884287834],
        [37.5266260783458, 127.1042740345],
        [37.5258773070672, 127.104005813599],
        [37.5255709893779, 127.103651762009],
        [37.5252731793075, 127.102814912796],
        [37.5235713846696, 127.101398706436],
      ];

      // ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        initMap();
        initEventListeners();
        initParticipantInfo();
        log("ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ");
      });

      // ì§€ë„ ì´ˆê¸°í™”
      function initMap() {
        // ì§€ë„ ìƒì„± (ì„œìš¸ ê°•ë‚¨ ì§€ì—­)
        map = L.map("map").setView([37.5353682776934, 127.11048334837], 14);

        // íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);

        // GPX ê²½ë¡œ í‘œì‹œ
        gpxRoute = L.polyline(GPX_POINTS, {
          color: "#2563eb",
          weight: 5,
          opacity: 0.8,
        }).addTo(map);

        // ì‹œì‘ì ê³¼ ëì  ë§ˆì»¤
        L.marker(GPX_POINTS[0]).addTo(map).bindPopup("ğŸ ì‹œì‘ì ").openPopup();

        L.marker(GPX_POINTS[GPX_POINTS.length - 1])
          .addTo(map)
          .bindPopup("ğŸ ë„ì°©ì ");

        // ì§€ë„ ë²”ìœ„ë¥¼ GPX ê²½ë¡œì— ë§ì¶¤
        map.fitBounds(gpxRoute.getBounds(), { padding: [20, 20] });
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
      function initEventListeners() {
        document
          .getElementById("initBtn")
          .addEventListener("click", initializeSystem);
        document
          .getElementById("startBtn")
          .addEventListener("click", startSimulation);
        document
          .getElementById("pauseBtn")
          .addEventListener("click", pauseSimulation);
        document
          .getElementById("stopBtn")
          .addEventListener("click", stopSimulation);
        document
          .getElementById("resetBtn")
          .addEventListener("click", resetSimulation);
        document
          .getElementById("stopBatchBtn")
          .addEventListener("click", stopBatchTest);

        // ê°œë³„ ì„¤ì • ë²„íŠ¼ë“¤
        document
          .getElementById("createEventBtn")
          .addEventListener("click", createEvent);
        document
          .getElementById("createCourseBtn")
          .addEventListener("click", createCourse);
        document
          .getElementById("createUsersBtn")
          .addEventListener("click", createUsers);
        document
          .getElementById("checkStatusBtn")
          .addEventListener("click", checkStatus);

        // ìƒˆë¡œìš´ GPS í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤
        document
          .getElementById("generateFakeBtn")
          .addEventListener("click", generateFakeGpsData);
        document
          .getElementById("batchTestBtn")
          .addEventListener("click", () => batchTestSingleUser(1));
        document
          .getElementById("allUsersBatchBtn")
          .addEventListener("click", batchTestAllUsers);

        // ì‹œë®¬ë ˆì´ì…˜ ì†ë„ ì¡°ì ˆ
        document
          .getElementById("speedRange")
          .addEventListener("input", function (e) {
            simulationSpeed = parseInt(e.target.value);
            document.getElementById("speedValue").textContent =
              simulationSpeed + "x";
            log(`ì‹œë®¬ë ˆì´ì…˜ ì†ë„ ë³€ê²½: ${simulationSpeed}x`);
          });

        // GPS ì˜¤ì°¨ ë²”ìœ„ ì¡°ì ˆ
        document
          .getElementById("errorRange")
          .addEventListener("input", function (e) {
            gpsErrorRange = parseInt(e.target.value);
            document.getElementById("errorValue").textContent =
              gpsErrorRange + "m";
            log(`GPS ì˜¤ì°¨ ë²”ìœ„ ë³€ê²½: ${gpsErrorRange}m`);
          });

        // ì£¼ê¸°ì  Fake GPS ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("startPeriodicFakeBtn")
          .addEventListener("click", startPeriodicFakeGpsSend);
        document
          .getElementById("stopPeriodicFakeBtn")
          .addEventListener("click", stopPeriodicFakeGpsSend);
      }

      // ì°¸ê°€ì ì •ë³´ ì´ˆê¸°í™”
      function initParticipantInfo() {
        const container = document.getElementById("participantInfo");
        container.innerHTML = "";

        TEST_USERS.forEach((user) => {
          const userDiv = document.createElement("div");
          userDiv.className = `user-info user-info-${user.userId}`;
          userDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${user.name}</strong> (${user.bibNumber})
                            <span class="status-indicator status-stopped" id="status-${user.userId}"></span>
                        </div>
                        <div class="stats" id="stats-${user.userId}">
                            ì¤€ë¹„ ì¤‘
                        </div>
                    </div>
                    <div class="stats" id="location-${user.userId}">
                        ìœ„ì¹˜: ëŒ€ê¸° ì¤‘
                    </div>
                `;
          container.appendChild(userDiv);
        });
      }

      // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      async function initializeSystem() {
        log("ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...");

        try {
          // 1. Event ìƒì„±
          log("1. ì´ë²¤íŠ¸ ìƒì„± ì¤‘...");
          const eventResponse = await fetch(
            `${API_BASE}/api/gpx/create-test-event?eventId=${EVENT_ID}&eventName=TestMarathon`,
            {
              method: "POST",
            }
          );

          if (eventResponse.ok) {
            log("âœ… ì´ë²¤íŠ¸ ìƒì„± ì™„ë£Œ");
          } else {
            log("âš ï¸ ì´ë²¤íŠ¸ ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ì˜¤ë¥˜)");
          }

          // 2. EventDetail ìƒì„±
          log("2. ì½”ìŠ¤ ìƒì„± ì¤‘...");
          const courseResponse = await fetch(
            `${API_BASE}/api/gpx/create-test-course?eventId=${EVENT_ID}&eventDetailId=${EVENT_DETAIL_ID}&courseName=TestCourse`,
            {
              method: "POST",
            }
          );

          if (courseResponse.ok) {
            log("âœ… ì½”ìŠ¤ ìƒì„± ì™„ë£Œ");
          } else {
            log("âš ï¸ ì½”ìŠ¤ ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ì˜¤ë¥˜)");
          }

          // 3. GPX íŒŒì¼ ì—…ë¡œë“œ
          log("3. GPX íŒŒì¼ ì—…ë¡œë“œ ì¤‘...");
          // GPX íŒŒì¼ì´ ì´ë¯¸ ì—…ë¡œë“œë˜ì–´ ìˆë‹¤ê³  ê°€ì •
          log("âœ… GPX íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ (ì´ë¯¸ ì¡´ì¬)");

          // 4. í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„±
          log("4. í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± ì¤‘...");
          const usersResponse = await fetch(
            `${API_BASE}/api/gpx/create-test-users?eventId=${EVENT_ID}&eventDetailId=${EVENT_DETAIL_ID}`,
            {
              method: "POST",
            }
          );

          if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            log("âœ… í…ŒìŠ¤íŠ¸ ìœ ì € 5ëª… ìƒì„± ì™„ë£Œ");
            log(
              `   ìƒì„±ëœ ìœ ì €: ${usersData.users.map((u) => u.name).join(", ")}`
            );
          } else {
            log("âŒ í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± ì‹¤íŒ¨");
          }

          // 5. ìœ ì € ë§ˆì»¤ ì´ˆê¸°í™”
          initUserMarkers();

          log("ğŸ‰ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ! ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          log(`âŒ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
        }
      }

      // ìœ ì € ë§ˆì»¤ ì´ˆê¸°í™”
      function initUserMarkers() {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        Object.values(userMarkers).forEach((marker) => {
          map.removeLayer(marker);
        });
        userMarkers = {};

        // ëª¨ë“  ìœ ì €ë¥¼ ì‹œì‘ì ì— ë°°ì¹˜
        TEST_USERS.forEach((user) => {
          const startPoint = GPX_POINTS[0];
          currentPositions[user.userId] = {
            pointIndex: 0,
            progress: 0,
            lat: startPoint[0],
            lng: startPoint[1],
            lastUpdate: Date.now(),
          };

          // ì»¤ìŠ¤í…€ ë§ˆì»¤ ìƒì„±
          const markerElement = L.divIcon({
            className: "custom-marker",
            html: `<div class="user-marker user-${user.userId}">${user.userId}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
          });

          const marker = L.marker([startPoint[0], startPoint[1]], {
            icon: markerElement,
          })
            .addTo(map)
            .bindPopup(`${user.name} (${user.bibNumber})`);

          userMarkers[user.userId] = marker;

          updateUserStatus(user.userId, "stopped", "ì¤€ë¹„ ì™„ë£Œ");
        });
      }

      // ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
      function startSimulation() {
        if (simulationRunning) {
          log("âš ï¸ ì‹œë®¬ë ˆì´ì…˜ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }

        if (batchTestRunning) {
          log(
            "âš ï¸ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ë¨¼ì € ë°°ì¹˜ í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”."
          );
          return;
        }

        simulationRunning = true;
        log("ğŸš€ ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘");

        // ëª¨ë“  ìœ ì € ìƒíƒœë¥¼ runningìœ¼ë¡œ ë³€ê²½
        TEST_USERS.forEach((user) => {
          updateUserStatus(user.userId, "running", "ì§„í–‰ ì¤‘");
        });

        // ì‹œë®¬ë ˆì´ì…˜ ë£¨í”„ ì‹œì‘ (1ì´ˆë§ˆë‹¤)
        simulationInterval = setInterval(() => {
          updateSimulation();
        }, 1000 / simulationSpeed);

        // 1ë¶„ë§ˆë‹¤ ìœ„ì¹˜ ë³´ì • API í˜¸ì¶œ
        setInterval(() => {
          if (simulationRunning) {
            sendLocationCorrection();
          }
        }, 600000); // 60ì´ˆ
      }

      // ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸
      function updateSimulation() {
        TEST_USERS.forEach((user) => {
          updateUserPosition(user.userId);
        });
        updateLeaderboard(); // í•­ìƒ í˜¸ì¶œ
      }

      // ìœ ì € ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      function updateUserPosition(userId) {
        const position = currentPositions[userId];
        if (!position) return;

        // ê° ìœ ì €ë§ˆë‹¤ ë‹¤ë¥¸ ì†ë„ë¡œ ì§„í–‰ (ì•½ê°„ì˜ ëœë¤ ìš”ì†Œ ì¶”ê°€)
        const baseSpeed = 0.005 + userId * 0.001; // ìœ ì €ë³„ ë‹¤ë¥¸ ê¸°ë³¸ ì†ë„
        const randomFactor = 0.5 + Math.random(); // 0.5 ~ 1.5 ëœë¤ ì†ë„
        const speed = baseSpeed * randomFactor;

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        position.progress += speed;

        // ë„ì°©ì ì— ë„ë‹¬í–ˆëŠ”ì§€ ì²´í¬
        if (
          position.pointIndex >= GPX_POINTS.length - 1 ||
          position.progress >= 1.0
        ) {
          // ë„ì°©ì ì— ê³ ì •
          position.pointIndex = GPX_POINTS.length - 1;
          position.progress = 1.0;
          position.lat = GPX_POINTS[GPX_POINTS.length - 1][0];
          position.lng = GPX_POINTS[GPX_POINTS.length - 1][1];
          position.lastUpdate = Date.now();

          // ë§ˆì»¤ ìœ„ì¹˜ ë„ì°©ì ì— ê³ ì •
          if (userMarkers[userId]) {
            userMarkers[userId].setLatLng([position.lat, position.lng]);
          }

          updateUserStatus(userId, "stopped", "ë„ì°©");
          updateLocationInfo(
            userId,
            position.lat,
            position.lng,
            2400,
            Math.floor(
              (Date.now() -
                (currentPositions[userId].startTime || Date.now())) /
                1000
            )
          );
          return;
        }

        // ë‹¤ìŒ í¬ì¸íŠ¸ë¡œ ì´ë™í• ì§€ ê²°ì •
        if (
          position.progress >= 1.0 &&
          position.pointIndex < GPX_POINTS.length - 1
        ) {
          position.pointIndex++;
          position.progress = 0;
        }

        // í˜„ì¬ ìœ„ì¹˜ ê³„ì‚° (ë‘ í¬ì¸íŠ¸ ê°„ ë³´ê°„, í•­ìƒ ë‹¤ìŒ í¬ì¸íŠ¸ ë°©í–¥)
        if (position.pointIndex < GPX_POINTS.length - 1) {
          const currentPoint = GPX_POINTS[position.pointIndex];
          const nextPoint = GPX_POINTS[position.pointIndex + 1];

          const lat =
            currentPoint[0] +
            (nextPoint[0] - currentPoint[0]) * position.progress;
          const lng =
            currentPoint[1] +
            (nextPoint[1] - currentPoint[1]) * position.progress;

          // GPS ì˜¤ì°¨ ì¶”ê°€ (ê°€ìš°ì‹œì•ˆ ë¶„í¬)
          const errorLat = (Math.random() - 0.5) * 2 * (gpsErrorRange / 111000); // ìœ„ë„ ì˜¤ì°¨
          const errorLng =
            (Math.random() - 0.5) *
            2 *
            (gpsErrorRange / (111000 * Math.cos((lat * Math.PI) / 180))); // ê²½ë„ ì˜¤ì°¨

          position.lat = lat + errorLat;
          position.lng = lng + errorLng;
          position.lastUpdate = Date.now();

          // ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          if (userMarkers[userId]) {
            userMarkers[userId].setLatLng([position.lat, position.lng]);
          }

          // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
          const distance =
            ((position.pointIndex + position.progress) / GPX_POINTS.length) *
            2400; // ëŒ€ëµ 2.4km
          const elapsedTime = Math.floor(
            (Date.now() - (currentPositions[userId].startTime || Date.now())) /
              1000
          );

          updateUserStatus(userId, "running", `${distance.toFixed(0)}m ì§„í–‰`);
          updateLocationInfo(
            userId,
            position.lat,
            position.lng,
            distance,
            elapsedTime
          );
        }
      }

      // ìœ„ì¹˜ ë³´ì • API í˜¸ì¶œ
      async function sendLocationCorrection() {
        log("ğŸ“¡ ìœ„ì¹˜ ë³´ì • API í˜¸ì¶œ ì¤‘...");

        const promises = TEST_USERS.map(async (user) => {
          const position = currentPositions[user.userId];
          if (!position) return;

          const gpsData = {
            userId: user.userId,
            eventId: EVENT_ID,
            eventDetailId: EVENT_DETAIL_ID,
            gpsData: [
              {
                lat: position.lat,
                lng: position.lng,
                altitude: 10.0,
                accuracy: 5.0,
                speed: 2.5,
                bearing: 180.0,
                timestamp: new Date().toISOString(),
              },
            ],
          };

          try {
            const response = await fetch(
              `${API_BASE}/api/gpx/correct-location`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(gpsData),
              }
            );

            log(
              `ğŸ“¥ ${user.name} ì‹¤ì‹œê°„ ë³´ì • ì‘ë‹µ: ${response.status} ${response.statusText}`
            );

            if (response.ok) {
              const result = await response.json();
              log(`âœ… ${user.name} ìœ„ì¹˜ ë³´ì • ì™„ë£Œ`);

              // ì²´í¬í¬ì¸íŠ¸ ë„ë‹¬ ì—¬ë¶€ í™•ì¸
              if (
                result.checkpointReaches &&
                result.checkpointReaches.length > 0
              ) {
                result.checkpointReaches.forEach((cp) => {
                  log(
                    `ğŸ¯ ${user.name} - ${cp.checkpointId} ë„ë‹¬! (ëˆ„ì ì‹œê°„: ${cp.cumulativeTime}ì´ˆ)`
                  );
                });
              }
            } else {
              // ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ì—ì„œë„ ì‹¤íŒ¨ ì›ì¸ ìƒì„¸ ë¶„ì„
              let errorDetails = `ìƒíƒœì½”ë“œ: ${response.status}`;

              try {
                const errorText = await response.text();
                if (errorText) {
                  errorDetails += `, ì‘ë‹µ: ${errorText}`;
                }
              } catch (e) {
                errorDetails += `, ì‘ë‹µ ì½ê¸° ì‹¤íŒ¨: ${e.message}`;
              }

              log(`âŒ ${user.name} ì‹¤ì‹œê°„ ìœ„ì¹˜ ë³´ì • ì‹¤íŒ¨ - ${errorDetails}`);
              log(
                `ğŸ“¤ ì‹¤íŒ¨í•œ ì‹¤ì‹œê°„ ìš”ì²­ ë°ì´í„°:\n${JSON.stringify(
                  gpsData,
                  null,
                  2
                )}`
              );
            }
          } catch (error) {
            log(`âŒ ${user.name} ìœ„ì¹˜ ë³´ì • ì˜¤ë¥˜: ${error.message}`);
            log(
              `ğŸ“¤ ì˜¤ë¥˜ ë°œìƒí•œ ìš”ì²­ ë°ì´í„°:\n${JSON.stringify(gpsData, null, 2)}`
            );
          }
        });

        await Promise.allSettled(promises);
      }

      // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸ (í•­ìƒ ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œë„ ê°±ì‹ )
      function updateLeaderboard() {
        // ì„œë²„ APIë„ ì‹œë„í•˜ì§€ë§Œ, í•­ìƒ ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œë„ ê°±ì‹ 
        fetch(`${API_BASE}/api/event-detail/${EVENT_ID}/${EVENT_DETAIL_ID}`)
          .then((response) => (response.ok ? response.json() : null))
          .then((eventDetail) => {
            if (
              eventDetail &&
              eventDetail.topRankers &&
              eventDetail.topRankers.length > 0
            ) {
              displayLeaderboard(eventDetail.topRankers);
            } else {
              displayLocalLeaderboard();
            }
          })
          .catch(() => {
            displayLocalLeaderboard();
          });
        // í•­ìƒ ë¡œì»¬ ê¸°ì¤€ ë¦¬ë”ë³´ë“œë„ ê°±ì‹ 
        displayLocalLeaderboard();
      }

      // ë¦¬ë”ë³´ë“œ í‘œì‹œ
      function displayLeaderboard(rankers) {
        const leaderboardEl = document.getElementById("leaderboard");

        if (rankers.length === 0) {
          displayLocalLeaderboard();
          return;
        }

        let html = "";
        rankers.forEach((ranker, index) => {
          const user = TEST_USERS.find(
            (u) => u.userId.toString() === ranker.userId
          );
          if (user) {
            html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                            <div>
                                <span class="badge bg-primary me-2">${
                                  index + 1
                                }</span>
                                <strong>${ranker.name}</strong> (${
              ranker.bibNumber
            })
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">${
                                  ranker.cumulativeTimeAtFarthestCp ||
                                  "00:00:00"
                                }</small>
                                <small class="text-muted">${
                                  ranker.cumulativeDistance
                                    ? ranker.cumulativeDistance.toFixed(0) + "m"
                                    : "0m"
                                }</small>
                            </div>
                        </div>
                    `;
          }
        });

        leaderboardEl.innerHTML =
          html || '<div class="text-center text-muted">ìˆœìœ„ ì •ë³´ ì—†ìŒ</div>';
      }

      // ë¡œì»¬ ë¦¬ë”ë³´ë“œ í‘œì‹œ
      function displayLocalLeaderboard() {
        const sortedUsers = TEST_USERS.map((user) => {
          const position = currentPositions[user.userId];
          if (!position) return { ...user, progress: 0 };

          return {
            ...user,
            progress:
              (position.pointIndex + position.progress) / GPX_POINTS.length,
          };
        }).sort((a, b) => b.progress - a.progress);

        let html = "";
        sortedUsers.forEach((user, index) => {
          const distance = user.progress * 2400; // ëŒ€ëµ 2.4km
          html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <span class="badge bg-primary me-2">${
                              index + 1
                            }</span>
                            <strong>${user.name}</strong> (${user.bibNumber})
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">${(
                              user.progress * 100
                            ).toFixed(1)}%</small>
                            <small class="text-muted">${distance.toFixed(
                              0
                            )}m</small>
                        </div>
                    </div>
                `;
        });

        document.getElementById("leaderboard").innerHTML = html;
      }

      // ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateUserStatus(userId, status, stats) {
        const statusEl = document.getElementById(`status-${userId}`);
        const statsEl = document.getElementById(`stats-${userId}`);

        if (statusEl) {
          statusEl.className = `status-indicator status-${status}`;
        }

        if (statsEl) {
          statsEl.textContent = stats;
        }
      }

      // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateLocationInfo(userId, lat, lng, distance, elapsedTime) {
        const locationEl = document.getElementById(`location-${userId}`);
        if (locationEl) {
          const timeStr = `${Math.floor(elapsedTime / 60)}:${(elapsedTime % 60)
            .toString()
            .padStart(2, "0")}`;
          locationEl.textContent = `ìœ„ì¹˜: ${lat.toFixed(6)}, ${lng.toFixed(
            6
          )} | ${distance.toFixed(0)}m | ${timeStr}`;
        }
      }

      // ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œì •ì§€
      function pauseSimulation() {
        if (!simulationRunning) return;

        clearInterval(simulationInterval);
        simulationRunning = false;

        TEST_USERS.forEach((user) => {
          updateUserStatus(user.userId, "paused", "ì¼ì‹œì •ì§€");
        });

        log("â¸ï¸ ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œì •ì§€");
      }

      // ì‹œë®¬ë ˆì´ì…˜ ì •ì§€
      function stopSimulation() {
        clearInterval(simulationInterval);
        simulationRunning = false;

        TEST_USERS.forEach((user) => {
          updateUserStatus(user.userId, "stopped", "ì •ì§€ë¨");
        });

        log("â¹ï¸ ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ ì •ì§€");
      }

      // ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì¤‘ì§€
      function stopBatchTest() {
        if (batchTestRunning) {
          batchTestRunning = false;

          TEST_USERS.forEach((user) => {
            updateUserStatus(user.userId, "stopped", "ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì¤‘ì§€ë¨");
          });

          log("â¹ï¸ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì¤‘ì§€");
        }
      }

      // ì‹œë®¬ë ˆì´ì…˜ ë¦¬ì…‹
      function resetSimulation() {
        stopSimulation();
        initUserMarkers();

        // ì‹œì‘ ì‹œê°„ ì´ˆê¸°í™”
        TEST_USERS.forEach((user) => {
          if (currentPositions[user.userId]) {
            currentPositions[user.userId].startTime = Date.now();
          }
        });

        log("ğŸ”„ ì‹œë®¬ë ˆì´ì…˜ ë¦¬ì…‹ ì™„ë£Œ");
      }

      // ë¡œê·¸ ì¶œë ¥
      function log(message) {
        const logArea = document.getElementById("logArea");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");

        // JSON í˜•íƒœì˜ ê¸´ ë©”ì‹œì§€ì¸ ê²½ìš° ìŠ¤íƒ€ì¼ë§ ì ìš©
        if (message.includes("{\n") || message.includes("[\n")) {
          logEntry.innerHTML = `<div style="margin-bottom: 5px;"><strong>[${timestamp}]</strong></div><pre style="background-color: #2d3748; color: #e2e8f0; padding: 8px; border-radius: 4px; font-size: 11px; overflow-x: auto; margin: 0;">${message}</pre>`;
        } else {
          logEntry.textContent = `[${timestamp}] ${message}`;
        }

        logArea.appendChild(logEntry);
        logArea.scrollTop = logArea.scrollHeight;

        console.log(`[GPS Simulation] ${message}`);
      }

      // ==== ìƒˆë¡œìš´ Fake GPS ë°ì´í„° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ ====

      // Fake GPS ë°ì´í„° ìƒì„±
      async function generateFakeGpsData() {
        log("ğŸ“± Fake GPS ë°ì´í„° ìƒì„± ì‹œì‘...");

        try {
          const response = await fetch(
            `${API_BASE}/api/gpx/generate-fake-gps-data?eventId=${EVENT_ID}&eventDetailId=${EVENT_DETAIL_ID}&intervalSeconds=10&errorRangeMeters=15`,
            {
              method: "GET",
            }
          );

          if (response.ok) {
            const data = await response.json();
            log(`âœ… Fake GPS ë°ì´í„° ìƒì„± ì™„ë£Œ!`);
            log(`   - ì´ ìœ ì €: ${data.totalUsers}ëª…`);
            log(`   - ê²½ë¡œ í¬ì¸íŠ¸: ${data.routeInfo.totalPoints}ê°œ`);
            log(`   - ì˜ˆìƒ ê±°ë¦¬: ${data.routeInfo.estimatedDistance}`);

            // ìœ ì €ë³„ ë°ì´í„° ì •ë³´ ì¶œë ¥
            data.users.forEach((user, index) => {
              log(
                `   - ${user.name} (${user.bibNumber}): ${user.totalPoints}ê°œ í¬ì¸íŠ¸, ì˜ˆìƒ ì†Œìš”ì‹œê°„ ${user.estimatedDurationMinutes}ë¶„`
              );
            });

            // ê° ìœ ì €ë³„ gpsDataë¥¼ 1ê°œ(ì²« ë²ˆì§¸ í¬ì¸íŠ¸)ë§Œ ë‚¨ê¸°ë„ë¡ ê°€ê³µí•´ì„œ ì €ì¥
            const singlePointData = {
              ...data,
              users: data.users.map((user) => ({
                ...user,
                gpsData:
                  user.gpsData && user.gpsData.length > 0
                    ? [user.gpsData[0]]
                    : [],
              })),
            };
            window.fakeGpsData = singlePointData;

            // ìƒì„±ëœ ì „ì²´ ë°ì´í„°ë¥¼ ì§€ë„ì— í‘œì‹œ (ì‹œê°í™”ëŠ” ì „ì²´ ê²½ë¡œ ì‚¬ìš©)
            displayFakeGpsRoute(data);
          } else {
            log("âŒ Fake GPS ë°ì´í„° ìƒì„± ì‹¤íŒ¨");
          }
        } catch (error) {
          log(`âŒ Fake GPS ë°ì´í„° ìƒì„± ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìƒì„±ëœ GPS ë°ì´í„°ë¥¼ ì§€ë„ì— í‘œì‹œ
      function displayFakeGpsRoute(data) {
        // ê¸°ì¡´ ê²½ë¡œ ì œê±°
        if (window.fakeRouteLayer) {
          map.removeLayer(window.fakeRouteLayer);
        }

        // ê° ìœ ì €ì˜ ê²½ë¡œë¥¼ ë‹¤ë¥¸ ìƒ‰ìœ¼ë¡œ í‘œì‹œ
        const colors = ["#ff4444", "#44ff44", "#4444ff", "#ffaa44", "#aa44ff"];
        window.fakeRouteLayer = L.layerGroup();

        data.users.forEach((user, index) => {
          const color = colors[index % colors.length];
          const gpsPoints = user.gpsData.map((point) => [point.lat, point.lng]);

          // ê²½ë¡œ ë¼ì¸ ê·¸ë¦¬ê¸°
          const routeLine = L.polyline(gpsPoints, {
            color: color,
            weight: 2,
            opacity: 0.7,
            dashArray: "5, 5",
          }).bindPopup(
            `${user.name} (${user.bibNumber}) - ${user.totalPoints}ê°œ í¬ì¸íŠ¸`
          );

          window.fakeRouteLayer.addLayer(routeLine);

          // ì‹œì‘ì  ë§ˆì»¤
          const startMarker = L.circleMarker(
            [gpsPoints[0][0], gpsPoints[0][1]],
            {
              color: color,
              fillColor: color,
              fillOpacity: 0.8,
              radius: 8,
            }
          ).bindPopup(`${user.name} - ì‹œì‘ì `);

          window.fakeRouteLayer.addLayer(startMarker);
        });

        window.fakeRouteLayer.addTo(map);
        log("ğŸ—ºï¸ ìƒì„±ëœ GPS ê²½ë¡œë¥¼ ì§€ë„ì— í‘œì‹œí–ˆìŠµë‹ˆë‹¤.");
      }

      // ë‹¨ì¼ ìœ ì € ë°°ì¹˜ í…ŒìŠ¤íŠ¸ (ì‹¤ì‹œê°„ ë§ˆì»¤ ì—…ë°ì´íŠ¸ í¬í•¨)
      async function batchTestSingleUser(userId) {
        if (simulationRunning) {
          log(
            "âš ï¸ ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ë¨¼ì € ì‹œë®¬ë ˆì´ì…˜ì„ ì •ì§€í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        // ê°œë³„ í…ŒìŠ¤íŠ¸ì¸ ê²½ìš° ìƒíƒœ ê´€ë¦¬
        const isIndividualTest = !batchTestRunning;

        if (isIndividualTest) {
          batchTestRunning = true;
        }

        log(`ğŸš€ ìœ ì € ${userId} ì‹¤ì‹œê°„ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...`);

        try {
          // 1. ë¨¼ì € fake GPS ë°ì´í„° ìƒì„± (ì•„ì§ ì•ˆ í–ˆë‹¤ë©´)
          if (!window.fakeGpsData) {
            log("ğŸ“± Fake GPS ë°ì´í„° ìƒì„± ì¤‘...");
            await generateFakeGpsData();
          }

          // 2. í•´ë‹¹ ìœ ì €ì˜ GPS ë°ì´í„° ì°¾ê¸°
          const userGpsData = window.fakeGpsData.users.find(
            (u) => u.userId === userId
          );
          if (!userGpsData) {
            log(`âŒ ìœ ì € ${userId}ì˜ GPS ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
          }

          const gpsDataList = userGpsData.gpsData;
          const userName = userGpsData.name;

          log(
            `ğŸ“ ${userName} GPS ë°ì´í„° ${gpsDataList.length}ê°œ í¬ì¸íŠ¸ ìˆœì°¨ ì²˜ë¦¬ ì‹œì‘`
          );

          // 3. ìœ ì € ìƒíƒœ ì—…ë°ì´íŠ¸
          updateUserStatus(userId, "running", "ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘");

          // 4. ê° GPS í¬ì¸íŠ¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
          let successCount = 0;
          let failCount = 0;

          for (let i = 0; i < gpsDataList.length; i++) {
            // ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì¤‘ì§€ í™•ì¸
            if (!batchTestRunning) {
              log(
                `â¹ï¸ ${userName} ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì¤‘ì§€ë¨ (ì§„í–‰ë¥ : ${(
                  (i / gpsDataList.length) *
                  100
                ).toFixed(1)}%)`
              );
              break;
            }

            const gpsPoint = gpsDataList[i];

            try {
              // 4-1. ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
              if (userMarkers[userId]) {
                userMarkers[userId].setLatLng([gpsPoint.lat, gpsPoint.lng]);
              }

              // 4-2. ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
              const progressPercent = (
                ((i + 1) / gpsDataList.length) *
                100
              ).toFixed(1);
              const distance = gpsPoint.distanceFromStart || i * 50; // ëŒ€ëµì ì¸ ê±°ë¦¬

              updateUserStatus(
                userId,
                "running",
                `${progressPercent}% ì™„ë£Œ (${distance}m)`
              );
              updateLocationInfo(
                userId,
                gpsPoint.lat,
                gpsPoint.lng,
                distance,
                i * 10
              );

              // 4-3. ì„œë²„ API í˜¸ì¶œ
              const gpsLocationData = {
                lat: gpsPoint.lat,
                lng: gpsPoint.lng,
                altitude: gpsPoint.altitude || 10.0,
                accuracy: gpsPoint.accuracy || 5.0,
                speed: gpsPoint.speed || 2.5,
                bearing: gpsPoint.bearing || 180.0,
                timestamp: gpsPoint.timestamp || new Date().toISOString(),
              };

              const requestDto = {
                userId: userId,
                eventId: EVENT_ID,
                eventDetailId: EVENT_DETAIL_ID,
                gpsData: [gpsLocationData],
              };

              // 4-3-1. ìš”ì²­ ë°ì´í„° ë¡œê¹… (ì²˜ìŒ ëª‡ ê°œë§Œ)
              if (i < 3) {
                log(
                  `ğŸ“¤ ${userName} í¬ì¸íŠ¸ ${
                    i + 1
                  } ìš”ì²­ ë°ì´í„°:\n${JSON.stringify(requestDto, null, 2)}`
                );
              }

              const response = await fetch(
                `${API_BASE}/api/gpx/correct-location`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(requestDto),
                }
              );

              // 4-3-2. ì‘ë‹µ ìƒíƒœ ì½”ë“œì™€ í—¤ë” í™•ì¸
              log(
                `ğŸ“¥ ${userName} í¬ì¸íŠ¸ ${i + 1} ì‘ë‹µ: ${response.status} ${
                  response.statusText
                }`
              );

              if (response.ok) {
                const correctionResult = await response.json();
                successCount++;

                // ì„±ê³µ ê²°ê³¼ ë¡œê¹… (ì²˜ìŒ ëª‡ ê°œë§Œ)
                if (i < 3) {
                  log(
                    `âœ… ${userName} í¬ì¸íŠ¸ ${
                      i + 1
                    } ë³´ì • ê²°ê³¼:\n${JSON.stringify(correctionResult, null, 2)}`
                  );
                }

                // 4-4. ë³´ì •ëœ ìœ„ì¹˜ë¡œ ë§ˆì»¤ ì—…ë°ì´íŠ¸ (ì˜µì…˜)
                if (
                  correctionResult.correctedLocations &&
                  correctionResult.correctedLocations.length > 0
                ) {
                  const corrected = correctionResult.correctedLocations[0];
                  if (userMarkers[userId]) {
                    userMarkers[userId].setLatLng([
                      corrected.correctedLatitude,
                      corrected.correctedLongitude,
                    ]);
                  }
                }

                // ì²´í¬í¬ì¸íŠ¸ ë„ë‹¬ í™•ì¸
                if (
                  correctionResult.checkpointReaches &&
                  correctionResult.checkpointReaches.length > 0
                ) {
                  correctionResult.checkpointReaches.forEach((cp) => {
                    log(
                      `ğŸ¯ ${userName} - ${cp.checkpointId} ë„ë‹¬! (ëˆ„ì ì‹œê°„: ${cp.cumulativeTime}ì´ˆ)`
                    );
                  });
                }
              } else {
                failCount++;

                // ì‹¤íŒ¨ ì›ì¸ ìƒì„¸ ë¶„ì„
                let errorDetails = `ìƒíƒœì½”ë“œ: ${response.status}`;

                try {
                  const errorText = await response.text();
                  if (errorText) {
                    errorDetails += `, ì‘ë‹µ: ${errorText}`;
                  }
                } catch (e) {
                  errorDetails += `, ì‘ë‹µ ì½ê¸° ì‹¤íŒ¨: ${e.message}`;
                }

                log(
                  `âŒ ${userName} í¬ì¸íŠ¸ ${
                    i + 1
                  } ìœ„ì¹˜ ë³´ì • ì‹¤íŒ¨ - ${errorDetails}`
                );

                // ìš”ì²­ ë°ì´í„°ë„ í•¨ê»˜ ë¡œê¹… (ì‹¤íŒ¨í•œ ê²½ìš°)
                log(
                  `ğŸ“¤ ì‹¤íŒ¨í•œ ìš”ì²­ ë°ì´í„°: ${JSON.stringify(
                    requestDto,
                    null,
                    2
                  )}`
                );
              }

              // 4-5. ì§„í–‰ë¥  ë¡œê¹… (10% ë‹¨ìœ„)
              if ((i + 1) % Math.ceil(gpsDataList.length / 10) === 0) {
                log(
                  `ğŸ“Š ${userName} ì§„í–‰ë¥ : ${progressPercent}% (${i + 1}/${
                    gpsDataList.length
                  })`
                );
              }

              // 4-6. ì²˜ë¦¬ ê°„ê²© ëŒ€ê¸° (ë§ˆì»¤ ì›€ì§ì„ì„ ë³¼ ìˆ˜ ìˆë„ë¡)
              await new Promise((resolve) => setTimeout(resolve, 200)); // 200ms ëŒ€ê¸°
            } catch (error) {
              failCount++;
              log(`âŒ ${userName} í¬ì¸íŠ¸ ${i + 1} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
          }

          // 5. ì™„ë£Œ ì²˜ë¦¬
          updateUserStatus(userId, "stopped", "ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ");
          log(`âœ… ${userName} ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!`);
          log(`   - ì´ í¬ì¸íŠ¸: ${gpsDataList.length}ê°œ`);
          log(`   - ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ`);
          log(`   - ì²˜ë¦¬ ì‹œê°„: ${(gpsDataList.length * 0.2).toFixed(1)}ì´ˆ`);
        } catch (error) {
          log(`âŒ ìœ ì € ${userId} ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
          updateUserStatus(userId, "stopped", "í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨");
        } finally {
          // ê°œë³„ í…ŒìŠ¤íŠ¸ì¸ ê²½ìš°ì—ë§Œ ìƒíƒœ í•´ì œ
          if (isIndividualTest) {
            batchTestRunning = false;
          }
        }
      }

      // ì „ì²´ ìœ ì € ë°°ì¹˜ í…ŒìŠ¤íŠ¸ (ì‹¤ì‹œê°„ ë§ˆì»¤ ì—…ë°ì´íŠ¸ í¬í•¨)
      async function batchTestAllUsers() {
        if (simulationRunning) {
          log(
            "âš ï¸ ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ë¨¼ì € ì‹œë®¬ë ˆì´ì…˜ì„ ì •ì§€í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        if (batchTestRunning) {
          log("âš ï¸ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }

        batchTestRunning = true;
        log(`ğŸƒâ€â™‚ï¸ ì „ì²´ ìœ ì € ì‹¤ì‹œê°„ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...`);

        try {
          // ë¨¼ì € fake GPS ë°ì´í„° ìƒì„±
          if (!window.fakeGpsData) {
            log("ğŸ“± Fake GPS ë°ì´í„° ìƒì„± ì¤‘...");
            await generateFakeGpsData();
          }

          const userIds = [1, 2, 3, 4, 5];

          // ë™ì‹œ ì‹¤í–‰ ì˜µì…˜ (true: ë™ì‹œ, false: ìˆœì°¨)
          const simultaneousExecution = false;

          if (simultaneousExecution) {
            // ë™ì‹œ ì‹¤í–‰ ëª¨ë“œ - ëª¨ë“  ìœ ì €ê°€ ë™ì‹œì— ì‹œì‘
            log("ğŸš€ ëª¨ë“  ìœ ì € ë™ì‹œ ì‹¤í–‰ ëª¨ë“œ");

            const promises = userIds.map(async (userId, index) => {
              // ê° ìœ ì €ë§ˆë‹¤ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ì‹œì°¨ ì‹œì‘
              await new Promise((resolve) => setTimeout(resolve, index * 1000));

              log(`ğŸ“ ìœ ì € ${userId} ë™ì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘... (ì§€ì—°: ${index}ì´ˆ)`);

              try {
                await batchTestSingleUser(userId);
              } catch (error) {
                log(`âŒ ìœ ì € ${userId} ë™ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
              }
            });

            await Promise.allSettled(promises);
          } else {
            // ìˆœì°¨ ì‹¤í–‰ ëª¨ë“œ - í•œ ëª…ì”© ì™„ë£Œ í›„ ë‹¤ìŒ ìœ ì €
            log("ğŸ”„ ìˆœì°¨ ì‹¤í–‰ ëª¨ë“œ");

            for (let i = 0; i < userIds.length; i++) {
              const userId = userIds[i];
              log(
                `ğŸ“ ìœ ì € ${userId} ìˆœì°¨ í…ŒìŠ¤íŠ¸ ì‹œì‘... (${i + 1}/${
                  userIds.length
                })`
              );

              try {
                await batchTestSingleUser(userId);

                // ê° ìœ ì € í…ŒìŠ¤íŠ¸ í›„ 2ì´ˆ ëŒ€ê¸°
                if (i < userIds.length - 1) {
                  log(`â³ ë‹¤ìŒ ìœ ì € í…ŒìŠ¤íŠ¸ê¹Œì§€ 2ì´ˆ ëŒ€ê¸°...`);
                  await new Promise((resolve) => setTimeout(resolve, 2000));
                }
              } catch (error) {
                log(`âŒ ìœ ì € ${userId} ìˆœì°¨ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
              }
            }
          }

          log(`ğŸ‰ ì „ì²´ ìœ ì € ì‹¤ì‹œê°„ ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!`);
          log(`ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${userIds.length}ëª… ì²˜ë¦¬ ì™„ë£Œ`);
        } catch (error) {
          log(`âŒ ì „ì²´ ìœ ì € ë°°ì¹˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
        } finally {
          batchTestRunning = false;
        }
      }

      // ====== ì£¼ê¸°ì  Fake GPS ë°ì´í„° ìƒì„± ë° ì „ì†¡ ======
      async function startPeriodicFakeGpsSend() {
        if (periodicFakeGpsInterval) {
          log("âš ï¸ ì´ë¯¸ ì£¼ê¸°ì  ì „ì†¡ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }
        log("â±ï¸ Fake GPS ë°ì´í„° ìƒì„± ë° ì£¼ê¸°ì  ì „ì†¡ ì‹œì‘...");
        try {
          const response = await fetch(
            "/api/v1/gpx/generate-fake-gps-data?eventId=1&eventDetailId=100",
            { method: "GET" }
          );
          if (!response.ok) {
            log("âŒ Fake GPS ë°ì´í„° ìƒì„± ì‹¤íŒ¨");
            return;
          }
          periodicFakeGpsData = await response.json();
          log(
            `âœ… Fake GPS ë°ì´í„° ìƒì„± ê²°ê³¼:\n${JSON.stringify(
              periodicFakeGpsData,
              null,
              2
            )}`
          );

          periodicFakeGpsInterval = setInterval(async () => {
            if (!periodicFakeGpsData || !periodicFakeGpsData.users) {
              log("âŒ ì „ì†¡í•  Fake GPS ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
              return;
            }
            for (const user of periodicFakeGpsData.users) {
              try {
                const requestBody = {
                  userId: user.userId,
                  eventId: 1,
                  eventDetailId: 100,
                  gpsData: user.gpsData,
                };
                log(
                  `ğŸ“¤ ìœ ì € ${
                    user.name
                  } correct-location ìš”ì²­:\n${JSON.stringify(
                    requestBody,
                    null,
                    2
                  )}`
                );
                const postRes = await fetch("/api/v1/gpx/correct-location", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(requestBody),
                });
                const resultText = await postRes.text();
                log(
                  `ğŸ“¥ ìœ ì € ${user.name} correct-location ì‘ë‹µ: ${postRes.status} ${postRes.statusText}\n${resultText}`
                );
              } catch (err) {
                log(
                  `âŒ ìœ ì € ${user.name} correct-location ì „ì†¡ ì‹¤íŒ¨: ${err.message}`
                );
              }
            }
            log("â±ï¸ Fake GPS ë°ì´í„° 1íšŒ ì „ì†¡ ì™„ë£Œ");
          }, 60000);
        } catch (error) {
          log(`âŒ Fake GPS ë°ì´í„° ìƒì„± ì˜¤ë¥˜: ${error.message}`);
        }
      }

      function stopPeriodicFakeGpsSend() {
        if (periodicFakeGpsInterval) {
          clearInterval(periodicFakeGpsInterval);
          periodicFakeGpsInterval = null;
          log("â¹ï¸ Fake GPS ì£¼ê¸°ì  ì „ì†¡ ì¤‘ì§€");
        } else {
          log("âš ï¸ ì£¼ê¸°ì  ì „ì†¡ì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.");
        }
      }

      // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ì‹œê°„ í¬ë§·íŒ…
      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) {
          return `${hours}:${minutes.toString().padStart(2, "0")}:${secs
            .toString()
            .padStart(2, "0")}`;
        } else {
          return `${minutes}:${secs.toString().padStart(2, "0")}`;
        }
      }

      // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ê±°ë¦¬ í¬ë§·íŒ…
      function formatDistance(meters) {
        if (meters >= 1000) {
          return `${(meters / 1000).toFixed(2)}km`;
        } else {
          return `${meters.toFixed(0)}m`;
        }
      }

      // ëŒ€íšŒ ìƒì„± API í˜¸ì¶œ
      async function createEvent() {
        log("ğŸ† ëŒ€íšŒ ìƒì„± ì‹œì‘...");
        try {
          const response = await fetch(
            `${API_BASE}/api/gpx/create-test-event?eventId=${EVENT_ID}&eventName=TestMarathon`,
            {
              method: "POST",
            }
          );
          if (response.ok) {
            log("âœ… ëŒ€íšŒ ìƒì„± ì™„ë£Œ");
          } else {
            log("âŒ ëŒ€íšŒ ìƒì„± ì‹¤íŒ¨");
          }
        } catch (error) {
          log(`âŒ ëŒ€íšŒ ìƒì„± ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ì½”ìŠ¤ ìƒì„± API í˜¸ì¶œ
      async function createCourse() {
        log("ğŸ›¤ï¸ ì½”ìŠ¤ ìƒì„± ì‹œì‘...");
        try {
          const response = await fetch(
            `${API_BASE}/api/gpx/create-test-course?eventId=${EVENT_ID}&eventDetailId=${EVENT_DETAIL_ID}&courseName=TestCourse`,
            {
              method: "POST",
            }
          );
          if (response.ok) {
            log("âœ… ì½”ìŠ¤ ìƒì„± ì™„ë£Œ");
          } else {
            log("âŒ ì½”ìŠ¤ ìƒì„± ì‹¤íŒ¨");
          }
        } catch (error) {
          log(`âŒ ì½”ìŠ¤ ìƒì„± ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìœ ì € ìƒì„± API í˜¸ì¶œ
      async function createUsers() {
        log("ğŸ‘¥ ìœ ì € ìƒì„± ì‹œì‘...");
        try {
          const response = await fetch(
            `${API_BASE}/api/gpx/create-test-users?eventId=${EVENT_ID}&eventDetailId=${EVENT_DETAIL_ID}`,
            {
              method: "POST",
            }
          );
          if (response.ok) {
            const usersData = await response.json();
            log("âœ… í…ŒìŠ¤íŠ¸ ìœ ì € 5ëª… ìƒì„± ì™„ë£Œ");
            log(
              `   ìƒì„±ëœ ìœ ì €: ${usersData.users.map((u) => u.name).join(", ")}`
            );
          } else {
            log("âŒ í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„± ì‹¤íŒ¨");
          }
        } catch (error) {
          log(`âŒ ìœ ì € ìƒì„± ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìƒíƒœ í™•ì¸ API í˜¸ì¶œ
      async function checkStatus() {
        log("ğŸ“Š ìƒíƒœ í™•ì¸ ì‹œì‘...");
        try {
          const response = await fetch(
            `${API_BASE}/api/event-detail/${EVENT_ID}/${EVENT_DETAIL_ID}`
          );
          if (response.ok) {
            const eventDetail = await response.json();
            log(`âœ… ìƒíƒœ í™•ì¸ ì™„ë£Œ: ${JSON.stringify(eventDetail)}`);
          } else {
            log("âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨");
          }
        } catch (error) {
          log(`âŒ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
