<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¬í”Œ GPS ì‹œë®¬ë ˆì´ì…˜</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background: #f4f6fa;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 500px;
        border-radius: 10px;
        margin: 20px auto 0 auto;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        max-width: 900px;
      }
      .log-area {
        max-width: 900px;
        margin: 30px auto;
        background: #222;
        color: #fff;
        font-size: 1.25em;
        border-radius: 10px;
        padding: 24px 18px;
        min-height: 200px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        font-family: "Fira Mono", monospace;
        overflow-y: auto;
        line-height: 1.7;
      }
      .btn {
        display: inline-block;
        margin: 20px 10px 0 10px;
        padding: 12px 32px;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }
      .btn:active {
        background: #1e40af;
      }
      .btn.stop {
        background: #dc2626;
      }
      .btn.stop:active {
        background: #991b1b;
      }
      .btn.setup {
        background: #059669;
      }
      .btn.setup:active {
        background: #047857;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center">
      <button id="createEventBtn" class="btn setup">
        1. í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„±
      </button>
      <button id="createCourseBtn" class="btn setup">
        2. í…ŒìŠ¤íŠ¸ ì½”ìŠ¤ ìƒì„±
      </button>
      <button id="uploadGpxBtn" class="btn setup">3. GPX ì—…ë¡œë“œ</button>
      <button id="loadGpxBtn" class="btn setup">4. GPX ë°ì´í„° ë¡œë“œ</button>
      <button id="createParticipantsBtn" class="btn setup">
        5. í…ŒìŠ¤íŠ¸ ì°¸ê°€ì ìƒì„±
      </button>
      <br />
      <button id="startBtn" class="btn">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
      <button id="stopBtn" class="btn stop">ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€</button>
    </div>
    <div id="map"></div>
    <div id="logArea" class="log-area"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // 1. ìœ ì € ë° GPX ê²½ë¡œ ìƒìˆ˜
      const USERS = [
        { userId: 1, name: "ê¹€ëŸ¬ë„ˆ", color: "#ff4444" },
        { userId: 2, name: "ì´ìŠ¤í”¼ë“œ", color: "#44ff44" },
        { userId: 3, name: "ë°•ë§ˆë¼í†¤", color: "#4444ff" },
        { userId: 4, name: "ìµœëŸ¬ë‹", color: "#ffaa44" },
        { userId: 5, name: "ì •íŠ¸ë™", color: "#aa44ff" },
      ];
      // GPX_POINTS ë°°ì—´ - APIì—ì„œ ë¡œë“œë˜ëŠ” ì‹¤ì œ ê²½ë¡œ ì¢Œí‘œ (êµ°ì‚°ìƒˆë§Œê¸ˆ ë§ˆë¼í†¤ ì½”ìŠ¤)
      let GPX_POINTS = [
        [35.9640808249908, 126.747851371765],
        [35.96364172472, 126.747975850981],
        [35.963202615667, 126.748100332687],
        [35.9628129854974, 126.748210787773],
        [35.962767610287, 126.748182757576],
        [35.9627391722972, 126.74816519022],
        [35.9626566751093, 126.747719943523],
        [35.962645912271, 126.747662983527],
        [35.962543896985, 126.747123089669],
        [35.9624418817, 126.746583195811],
        [35.9623657632854, 126.746180355549],
        [35.962347531011, 126.746041447806],
        [35.9623266854961, 126.745882630348],
        [35.962301548688, 126.74549043814],
        [35.962266132876, 126.744937869749],
        [35.962230717064, 126.744385301357],
        [35.962195301252, 126.743832732966],
      ];
      const EVENT_ID = 1;
      const EVENT_DETAIL_ID = 1;
      const API_URL = "/api/v1/gpx/correct-location";
      const GPS_ERROR_METERS = 5;
      const INTERVAL_SECONDS = 10;

      // 2. ì§€ë„ ì´ˆê¸°í™”
      let map,
        userMarkers = {};
      function initMap() {
        map = L.map("map").setView(GPX_POINTS[0], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);
        L.polyline(GPX_POINTS, {
          color: "#2563eb",
          weight: 5,
          opacity: 0.8,
        }).addTo(map);
        L.marker(GPX_POINTS[0]).addTo(map).bindPopup("ğŸ ì‹œì‘ì ").openPopup();
        L.marker(GPX_POINTS[GPX_POINTS.length - 1])
          .addTo(map)
          .bindPopup("ğŸ ë„ì°©ì ");
        map.fitBounds(L.polyline(GPX_POINTS).getBounds(), {
          padding: [20, 20],
        });
      }

      // Haversine ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (ë¯¸í„°)
      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = (deg) => (deg * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(a));
      }

      // 3. GPS ë°ì´í„° ìƒì„± (10ì´ˆ ê°„ê²©, 10m ì˜¤ì°¨, ìœ ì €ë³„ ì†ë„/íŒ¨í„´)
      function generateUserGpsArrays() {
        // ìœ ì €ë³„ ì†ë„(2.7~3.4 m/s) ëœë¤ ë¶€ì—¬
        const userSpeeds = USERS.map(() => 2.7 + Math.random() * 0.7);
        return USERS.map((user, idx) => {
          let gpsArray = [];
          let totalTime = 0;
          for (let i = 0; i < GPX_POINTS.length - 1; i++) {
            const [lat1, lng1] = GPX_POINTS[i];
            const [lat2, lng2] = GPX_POINTS[i + 1];
            const dist = getDistance(lat1, lng1, lat2, lng2); // ë¯¸í„°
            let speed = userSpeeds[idx] + (Math.random() - 0.5) * 0.2; // êµ¬ê°„ë³„ ì•½ê°„ ëœë¤
            let t = 0;
            while (t < dist) {
              const ratio = t / dist;
              const lat = lat1 + (lat2 - lat1) * ratio;
              const lng = lng1 + (lng2 - lng1) * ratio;
              // 10m ì˜¤ì°¨ ì ìš©
              const latErr =
                ((Math.random() - 0.5) * 2 * GPS_ERROR_METERS) / 111000;
              const lngErr =
                ((Math.random() - 0.5) * 2 * GPS_ERROR_METERS) /
                (111000 * Math.cos((lat * Math.PI) / 180));
              gpsArray.push({
                lat: lat + latErr,
                lng: lng + lngErr,
                altitude: 10.0,
                accuracy: 5.0,
                speed: speed,
                bearing: 180.0,
                timestamp: new Date(
                  Date.now() + totalTime * 1000
                ).toISOString(),
              });
              t += speed * INTERVAL_SECONDS;
              totalTime += INTERVAL_SECONDS;
            }
          }
          // ë§ˆì§€ë§‰ í¬ì¸íŠ¸ ì¶”ê°€
          const [lat2, lng2] = GPX_POINTS[GPX_POINTS.length - 1];
          gpsArray.push({
            lat: lat2,
            lng: lng2,
            altitude: 10.0,
            accuracy: 5.0,
            speed: userSpeeds[idx],
            bearing: 180.0,
            timestamp: new Date(Date.now() + totalTime * 1000).toISOString(),
          });
          return { ...user, gpsArray, currentIdx: 0 };
        });
      }

      // 4. 10ì´ˆë§ˆë‹¤ ê° ìœ ì €ì˜ ë‹¤ìŒ í¬ì¸íŠ¸ë¥¼ correct-locationì— POST
      let simulationInterval = null;
      let userSimStates = [];
      function startSimulation() {
        if (simulationInterval) {
          log("âš ï¸ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }
        userSimStates = generateUserGpsArrays();
        // ë§ˆì»¤ ì´ˆê¸°í™”
        userMarkers = {};
        userSimStates.forEach((user) => {
          const pt = user.gpsArray[0];
          const marker = L.circleMarker([pt.lat, pt.lng], {
            color: user.color,
            fillColor: user.color,
            fillOpacity: 0.9,
            radius: 10,
          })
            .addTo(map)
            .bindPopup(`${user.name}`);
          userMarkers[user.userId] = marker;
        });
        log("ğŸš€ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘");
        simulationInterval = setInterval(
          sendNextGpsPoints,
          INTERVAL_SECONDS * 1000
        );
        sendNextGpsPoints(); // ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
      }
      function stopSimulation() {
        if (simulationInterval) {
          clearInterval(simulationInterval);
          simulationInterval = null;
          log("â¹ï¸ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€");
        }
      }
      async function sendNextGpsPoints() {
        for (const user of userSimStates) {
          if (user.currentIdx >= user.gpsArray.length) continue;
          const gpsPoint = user.gpsArray[user.currentIdx];
          // ë§ˆì»¤ ì´ë™
          if (userMarkers[user.userId]) {
            userMarkers[user.userId].setLatLng([gpsPoint.lat, gpsPoint.lng]);
          }
          // correct-location POST
          const reqBody = {
            userId: user.userId,
            eventId: EVENT_ID,
            eventDetailId: EVENT_DETAIL_ID,
            gpsData: [gpsPoint],
          };
          log(
            `ğŸ“¤ <b>${user.name}</b> ìš”ì²­:<br><pre>${JSON.stringify(
              reqBody,
              null,
              2
            )}</pre>`
          );
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(reqBody),
            });
            const resText = await res.text();
            log(
              `ğŸ“¥ <b>${user.name}</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
            );
          } catch (e) {
            log(`âŒ <b>${user.name}</b> ì „ì†¡ ì˜¤ë¥˜: ${e.message}`);
          }
          user.currentIdx++;
        }
      }

      // 5. ë¡œê·¸ í•¨ìˆ˜ (í¬ê²Œ, ìµœê·¼ì´ ë§¨ ìœ„)
      function log(msg) {
        const logArea = document.getElementById("logArea");
        const time = new Date().toLocaleTimeString();
        const entry = `<div style="margin-bottom:18px;"><span style="font-weight:bold;color:#60a5fa;">[${time}]</span> ${msg}</div>`;
        logArea.innerHTML = entry + logArea.innerHTML;
      }

      // 6. ì´ˆê¸° ì„¤ì • API í˜¸ì¶œ í•¨ìˆ˜ë“¤
      async function createTestEvent() {
        log("ğŸƒ í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„± ì¤‘...");
        try {
          const url = `/api/v1/gpx/create-test-event?eventId=${EVENT_ID}&name=í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const resText = await res.text();
          log(
            `ğŸ“¥ <b>í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„±</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log("âœ… í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„± ì™„ë£Œ!");
          }
        } catch (e) {
          log(`âŒ í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„± ì˜¤ë¥˜: ${e.message}`);
        }
      }

      async function createTestCourse() {
        log("ğŸ í…ŒìŠ¤íŠ¸ ì½”ìŠ¤ ìƒì„± ì¤‘...");
        try {
          const url = `/api/v1/gpx/create-test-course?eventId=${EVENT_ID}&courseName=í…ŒìŠ¤íŠ¸ ì½”ìŠ¤`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const resText = await res.text();
          log(
            `ğŸ“¥ <b>í…ŒìŠ¤íŠ¸ ì½”ìŠ¤ ìƒì„±</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log("âœ… í…ŒìŠ¤íŠ¸ ì½”ìŠ¤ ìƒì„± ì™„ë£Œ!");
          }
        } catch (e) {
          log(`âŒ í…ŒìŠ¤íŠ¸ ì½”ìŠ¤ ìƒì„± ì˜¤ë¥˜: ${e.message}`);
        }
      }

      async function uploadTestGpx() {
        log("ğŸ“‚ GPX íŒŒì¼ ì—…ë¡œë“œ ì¤‘...");

        // GPX í¬ì¸íŠ¸ë¥¼ GPX í˜•ì‹ ë¬¸ìì—´ë¡œ ë³€í™˜
        const gpxContent = generateGpxContent();

        // FormDataë¡œ íŒŒì¼ ì—…ë¡œë“œ ì¤€ë¹„
        const formData = new FormData();
        const gpxBlob = new Blob([gpxContent], { type: "application/gpx+xml" });
        formData.append("file", gpxBlob, "test_route.gpx");
        formData.append("eventId", EVENT_ID);
        formData.append("userId", "1");
        formData.append("eventDetailId", EVENT_DETAIL_ID);
        formData.append("routeName", "í…ŒìŠ¤íŠ¸ ê²½ë¡œ");
        formData.append("description", "GPS ì‹œë®¬ë ˆì´ì…˜ìš© í…ŒìŠ¤íŠ¸ ê²½ë¡œ");

        try {
          const res = await fetch("/api/v1/gpx/upload-gpx", {
            method: "POST",
            body: formData,
          });
          const resText = await res.text();
          log(
            `ğŸ“¥ <b>GPX ì—…ë¡œë“œ</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log("âœ… GPX íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!");
            // ì—…ë¡œë“œ ì„±ê³µ í›„ GPX ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            await loadGpxPointsFromApi();
          }
        } catch (e) {
          log(`âŒ GPX ì—…ë¡œë“œ ì˜¤ë¥˜: ${e.message}`);
        }
      }

      async function createTestParticipants() {
        log("ğŸ‘¥ í…ŒìŠ¤íŠ¸ ì°¸ê°€ì ìƒì„± ì¤‘...");

        // ìƒì„±í•  ì°¸ê°€ì ìˆ˜ (ê¸°ë³¸ 50ëª…, ìµœëŒ€ 1000ëª…)
        const participantCount = 50;

        const requestBody = {
          eventId: EVENT_ID,
          eventDetailId: EVENT_DETAIL_ID,
          count: participantCount,
        };

        log(
          `ğŸ“¤ ì°¸ê°€ì ìƒì„± ìš”ì²­: <pre>${JSON.stringify(
            requestBody,
            null,
            2
          )}</pre>`
        );

        try {
          const res = await fetch("/api/participants/test/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });
          const resText = await res.text();
          log(
            `ğŸ“¥ <b>í…ŒìŠ¤íŠ¸ ì°¸ê°€ì ìƒì„±</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log(`âœ… í…ŒìŠ¤íŠ¸ ì°¸ê°€ì ${participantCount}ëª… ìƒì„± ì™„ë£Œ!`);
          }
        } catch (e) {
          log(`âŒ í…ŒìŠ¤íŠ¸ ì°¸ê°€ì ìƒì„± ì˜¤ë¥˜: ${e.message}`);
        }
      }

      // APIì—ì„œ GPX íŒŒì‹± ë°ì´í„° ë¡œë“œ
      async function loadGpxPointsFromApi() {
        log("ğŸ“¡ Redisì—ì„œ GPX ë°ì´í„° ë¡œë“œ ì¤‘...");

        try {
          const res = await fetch(
            `/api/v1/gpx/redis/${EVENT_ID}/${EVENT_DETAIL_ID}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const result = await res.json();
          log(
            `ğŸ“¡ <b>GPX ë°ì´í„° ë¡œë“œ</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b>`
          );

          if (
            res.ok &&
            result.data &&
            result.data.success &&
            result.data.points
          ) {
            const points = result.data.points;
            log(`âœ… GPX ë°ì´í„° ë¡œë“œ ì„±ê³µ! (${points.length}ê°œ í¬ì¸íŠ¸)`);

            // GPX_POINTS ë°°ì—´ ì—…ë°ì´íŠ¸
            GPX_POINTS = points.map((point) => [
              point.latitude,
              point.longitude,
            ]);
            log(
              `ğŸ”„ GPX_POINTS ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì²˜ìŒ 3ê°œ: ${JSON.stringify(
                GPX_POINTS.slice(0, 3)
              )})`
            );

            // ì§€ë„ ì—…ë°ì´íŠ¸
            updateMapWithNewPoints();

            return true;
          } else {
            log("âš ï¸ GPX ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € GPX íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
            return false;
          }
        } catch (e) {
          log(`âŒ GPX ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${e.message}`);
          return false;
        }
      }

      // ì§€ë„ì— ìƒˆë¡œìš´ GPX í¬ì¸íŠ¸ ì ìš©
      function updateMapWithNewPoints() {
        try {
          // ê¸°ì¡´ GPX ê²½ë¡œ ë ˆì´ì–´ ì œê±°
          map.eachLayer(function (layer) {
            if (
              layer instanceof L.Polyline &&
              layer.options.color === "#2563eb"
            ) {
              map.removeLayer(layer);
            }
          });

          // ìƒˆë¡œìš´ GPX ê²½ë¡œ ì¶”ê°€
          L.polyline(GPX_POINTS, {
            color: "#2563eb",
            weight: 5,
            opacity: 0.7,
          }).addTo(map);

          // ì§€ë„ ë·° ì¡°ì •
          if (GPX_POINTS.length > 0) {
            const bounds = L.latLngBounds(GPX_POINTS);
            map.fitBounds(bounds, { padding: [20, 20] });
          }

          log("ğŸ—ºï¸ ì§€ë„ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
        } catch (e) {
          log(`âŒ ì§€ë„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${e.message}`);
        }
      }

      // GPX í˜•ì‹ ë¬¸ìì—´ ìƒì„± í•¨ìˆ˜
      function generateGpxContent() {
        let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPS ì‹œë®¬ë ˆì´ì…˜" 
     xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd"
     xmlns="http://www.topografix.com/GPX/1/1" 
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <metadata>
    <name>í…ŒìŠ¤íŠ¸ ë£¨íŠ¸</name>
    <desc>GPS ì‹œë®¬ë ˆì´ì…˜ìš© í…ŒìŠ¤íŠ¸ ê²½ë¡œ</desc>
  </metadata>
  <trk>
    <name>Test Route</name>
    <trkseg>
`;

        GPX_POINTS.forEach((point, index) => {
          gpxContent += `      <trkpt lat="${point[0]}" lon="${point[1]}">
        <ele>10.0</ele>
        <time>${new Date(Date.now() + index * 1000).toISOString()}</time>
      </trkpt>
`;
        });

        gpxContent += `    </trkseg>
  </trk>
</gpx>`;

        return gpxContent;
      }

      // 7. ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("createEventBtn").onclick = createTestEvent;
      document.getElementById("createCourseBtn").onclick = createTestCourse;
      document.getElementById("uploadGpxBtn").onclick = uploadTestGpx;
      document.getElementById("loadGpxBtn").onclick = loadGpxPointsFromApi;
      document.getElementById("createParticipantsBtn").onclick =
        createTestParticipants;
      document.getElementById("startBtn").onclick = startSimulation;
      document.getElementById("stopBtn").onclick = stopSimulation;

      // 8. ì´ˆê¸°í™”
      window.onload = async function () {
        initMap();
        log("ğŸš€ GPS ì‹œë®¬ë ˆì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ");

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ GPX ë°ì´í„° ë¡œë“œ ì‹œë„
        log("ğŸ”„ ê¸°ì¡´ GPX ë°ì´í„° ìë™ ë¡œë“œ ì¤‘...");
        const loaded = await loadGpxPointsFromApi();
        if (!loaded) {
          log(
            "ğŸ“Œ GPX ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • ë²„íŠ¼ì„ ìˆœì„œëŒ€ë¡œ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ì¤€ë¹„í•˜ì„¸ìš”."
          );
        }
      };
    </script>
  </body>
</html>
