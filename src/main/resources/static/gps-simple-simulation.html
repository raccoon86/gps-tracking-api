<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¬í”Œ GPS ì‹œë®¬ë ˆì´ì…˜</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background: #f4f6fa;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 500px;
        border-radius: 10px;
        margin: 20px auto 0 auto;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        max-width: 900px;
      }
      .log-area {
        max-width: 900px;
        margin: 30px auto;
        background: #222;
        color: #fff;
        font-size: 1.25em;
        border-radius: 10px;
        padding: 24px 18px;
        min-height: 200px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        font-family: "Fira Mono", monospace;
        overflow-y: auto;
        line-height: 1.7;
      }
      .btn {
        display: inline-block;
        margin: 20px 10px 0 10px;
        padding: 12px 32px;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }
      .btn:active {
        background: #1e40af;
      }
      .btn.stop {
        background: #dc2626;
      }
      .btn.stop:active {
        background: #991b1b;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center">
      <button id="startBtn" class="btn">ì‹œì‘</button>
      <button id="stopBtn" class="btn stop">ì¤‘ì§€</button>
    </div>
    <div id="map"></div>
    <div id="logArea" class="log-area"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // 1. ìœ ì € ë° GPX ê²½ë¡œ ìƒìˆ˜
      const USERS = [
        { userId: 1, name: "ê¹€ëŸ¬ë„ˆ", color: "#ff4444" },
        { userId: 2, name: "ì´ìŠ¤í”¼ë“œ", color: "#44ff44" },
        { userId: 3, name: "ë°•ë§ˆë¼í†¤", color: "#4444ff" },
        { userId: 4, name: "ìµœëŸ¬ë‹", color: "#ffaa44" },
        { userId: 5, name: "ì •íŠ¸ë™", color: "#aa44ff" },
      ];
      const GPX_POINTS = [
        [37.5413553485092, 127.115719020367],
        [37.5390881874808, 127.114029228687],
        [37.5379482005428, 127.113452553749],
        [37.5353682776934, 127.11048334837],
        [37.5351258071487, 127.110266089439],
        [37.5344154064531, 127.109783291817],
        [37.5337836971563, 127.109482884407],
        [37.5320799696497, 127.108764052391],
        [37.5317162475003, 127.108696997166],
        [37.5315503385624, 127.108699679375],
        [37.5301273352067, 127.107908427715],
        [37.5301188268838, 127.107884287834],
        [37.5266260783458, 127.1042740345],
        [37.5258773070672, 127.104005813599],
        [37.5255709893779, 127.103651762009],
        [37.5252731793075, 127.102814912796],
        [37.5235713846696, 127.101398706436],
      ];
      const EVENT_ID = 1;
      const EVENT_DETAIL_ID = 100;
      const API_URL = "/api/v1/gpx/correct-location";
      const GPS_ERROR_METERS = 5;
      const INTERVAL_SECONDS = 10;

      // 2. ì§€ë„ ì´ˆê¸°í™”
      let map,
        userMarkers = {};
      function initMap() {
        map = L.map("map").setView(GPX_POINTS[0], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);
        L.polyline(GPX_POINTS, {
          color: "#2563eb",
          weight: 5,
          opacity: 0.8,
        }).addTo(map);
        L.marker(GPX_POINTS[0]).addTo(map).bindPopup("ğŸ ì‹œì‘ì ").openPopup();
        L.marker(GPX_POINTS[GPX_POINTS.length - 1])
          .addTo(map)
          .bindPopup("ğŸ ë„ì°©ì ");
        map.fitBounds(L.polyline(GPX_POINTS).getBounds(), {
          padding: [20, 20],
        });
      }

      // Haversine ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (ë¯¸í„°)
      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = (deg) => (deg * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(a));
      }

      // 3. GPS ë°ì´í„° ìƒì„± (10ì´ˆ ê°„ê²©, 10m ì˜¤ì°¨, ìœ ì €ë³„ ì†ë„/íŒ¨í„´)
      function generateUserGpsArrays() {
        // ìœ ì €ë³„ ì†ë„(2.7~3.4 m/s) ëœë¤ ë¶€ì—¬
        const userSpeeds = USERS.map(() => 2.7 + Math.random() * 0.7);
        return USERS.map((user, idx) => {
          let gpsArray = [];
          let totalTime = 0;
          for (let i = 0; i < GPX_POINTS.length - 1; i++) {
            const [lat1, lng1] = GPX_POINTS[i];
            const [lat2, lng2] = GPX_POINTS[i + 1];
            const dist = getDistance(lat1, lng1, lat2, lng2); // ë¯¸í„°
            let speed = userSpeeds[idx] + (Math.random() - 0.5) * 0.2; // êµ¬ê°„ë³„ ì•½ê°„ ëœë¤
            let t = 0;
            while (t < dist) {
              const ratio = t / dist;
              const lat = lat1 + (lat2 - lat1) * ratio;
              const lng = lng1 + (lng2 - lng1) * ratio;
              // 10m ì˜¤ì°¨ ì ìš©
              const latErr =
                ((Math.random() - 0.5) * 2 * GPS_ERROR_METERS) / 111000;
              const lngErr =
                ((Math.random() - 0.5) * 2 * GPS_ERROR_METERS) /
                (111000 * Math.cos((lat * Math.PI) / 180));
              gpsArray.push({
                lat: lat + latErr,
                lng: lng + lngErr,
                altitude: 10.0,
                accuracy: 5.0,
                speed: speed,
                bearing: 180.0,
                timestamp: new Date(
                  Date.now() + totalTime * 1000
                ).toISOString(),
              });
              t += speed * INTERVAL_SECONDS;
              totalTime += INTERVAL_SECONDS;
            }
          }
          // ë§ˆì§€ë§‰ í¬ì¸íŠ¸ ì¶”ê°€
          const [lat2, lng2] = GPX_POINTS[GPX_POINTS.length - 1];
          gpsArray.push({
            lat: lat2,
            lng: lng2,
            altitude: 10.0,
            accuracy: 5.0,
            speed: userSpeeds[idx],
            bearing: 180.0,
            timestamp: new Date(Date.now() + totalTime * 1000).toISOString(),
          });
          return { ...user, gpsArray, currentIdx: 0 };
        });
      }

      // 4. 10ì´ˆë§ˆë‹¤ ê° ìœ ì €ì˜ ë‹¤ìŒ í¬ì¸íŠ¸ë¥¼ correct-locationì— POST
      let simulationInterval = null;
      let userSimStates = [];
      function startSimulation() {
        if (simulationInterval) {
          log("âš ï¸ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }
        userSimStates = generateUserGpsArrays();
        // ë§ˆì»¤ ì´ˆê¸°í™”
        userMarkers = {};
        userSimStates.forEach((user) => {
          const pt = user.gpsArray[0];
          const marker = L.circleMarker([pt.lat, pt.lng], {
            color: user.color,
            fillColor: user.color,
            fillOpacity: 0.9,
            radius: 10,
          })
            .addTo(map)
            .bindPopup(`${user.name}`);
          userMarkers[user.userId] = marker;
        });
        log("ğŸš€ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘");
        simulationInterval = setInterval(
          sendNextGpsPoints,
          INTERVAL_SECONDS * 1000
        );
        sendNextGpsPoints(); // ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
      }
      function stopSimulation() {
        if (simulationInterval) {
          clearInterval(simulationInterval);
          simulationInterval = null;
          log("â¹ï¸ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€");
        }
      }
      async function sendNextGpsPoints() {
        for (const user of userSimStates) {
          if (user.currentIdx >= user.gpsArray.length) continue;
          const gpsPoint = user.gpsArray[user.currentIdx];
          // ë§ˆì»¤ ì´ë™
          if (userMarkers[user.userId]) {
            userMarkers[user.userId].setLatLng([gpsPoint.lat, gpsPoint.lng]);
          }
          // correct-location POST
          const reqBody = {
            userId: user.userId,
            eventId: EVENT_ID,
            eventDetailId: EVENT_DETAIL_ID,
            gpsData: [gpsPoint],
          };
          log(
            `ğŸ“¤ <b>${user.name}</b> ìš”ì²­:<br><pre>${JSON.stringify(
              reqBody,
              null,
              2
            )}</pre>`
          );
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(reqBody),
            });
            const resText = await res.text();
            log(
              `ğŸ“¥ <b>${user.name}</b> ì‘ë‹µ: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
            );
          } catch (e) {
            log(`âŒ <b>${user.name}</b> ì „ì†¡ ì˜¤ë¥˜: ${e.message}`);
          }
          user.currentIdx++;
        }
      }

      // 5. ë¡œê·¸ í•¨ìˆ˜ (í¬ê²Œ, ìµœê·¼ì´ ë§¨ ìœ„)
      function log(msg) {
        const logArea = document.getElementById("logArea");
        const time = new Date().toLocaleTimeString();
        const entry = `<div style="margin-bottom:18px;"><span style="font-weight:bold;color:#60a5fa;">[${time}]</span> ${msg}</div>`;
        logArea.innerHTML = entry + logArea.innerHTML;
      }

      // 6. ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("startBtn").onclick = startSimulation;
      document.getElementById("stopBtn").onclick = stopSimulation;

      // 7. ì´ˆê¸°í™”
      window.onload = initMap;
    </script>
  </body>
</html>
