<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>심플 GPS 시뮬레이션</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background: #f4f6fa;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 500px;
        border-radius: 10px;
        margin: 20px auto 0 auto;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        max-width: 900px;
      }
      .log-area {
        max-width: 900px;
        margin: 30px auto;
        background: #222;
        color: #fff;
        font-size: 1.25em;
        border-radius: 10px;
        padding: 24px 18px;
        min-height: 200px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        font-family: "Fira Mono", monospace;
        overflow-y: auto;
        line-height: 1.7;
      }
      .btn {
        display: inline-block;
        margin: 20px 10px 0 10px;
        padding: 12px 32px;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }
      .btn:active {
        background: #1e40af;
      }
      .btn.stop {
        background: #dc2626;
      }
      .btn.stop:active {
        background: #991b1b;
      }
      .btn.setup {
        background: #059669;
      }
      .btn.setup:active {
        background: #047857;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center">
      <button id="createEventBtn" class="btn setup">
        1. 테스트 이벤트 생성
      </button>
      <button id="createCourseBtn" class="btn setup">
        2. 테스트 코스 생성
      </button>
      <button id="uploadGpxBtn" class="btn setup">3. GPX 업로드</button>
      <button id="loadGpxBtn" class="btn setup">4. GPX 데이터 로드</button>
      <button id="createParticipantsBtn" class="btn setup">
        5. 테스트 참가자 생성
      </button>
      <br />
      <button id="startBtn" class="btn">시뮬레이션 시작</button>
      <button id="stopBtn" class="btn stop">시뮬레이션 중지</button>
    </div>
    <div id="map"></div>
    <div id="logArea" class="log-area"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // 1. 유저 및 GPX 경로 상수
      const USERS = [
        { userId: 1, name: "김러너", color: "#ff4444" },
        { userId: 2, name: "이스피드", color: "#44ff44" },
        { userId: 3, name: "박마라톤", color: "#4444ff" },
        { userId: 4, name: "최러닝", color: "#ffaa44" },
        { userId: 5, name: "정트랙", color: "#aa44ff" },
      ];
      // GPX_POINTS 배열 - API에서 로드되는 실제 경로 좌표 (군산새만금 마라톤 코스)
      let GPX_POINTS = [
        [35.9640808249908, 126.747851371765],
        [35.96364172472, 126.747975850981],
        [35.963202615667, 126.748100332687],
        [35.9628129854974, 126.748210787773],
        [35.962767610287, 126.748182757576],
        [35.9627391722972, 126.74816519022],
        [35.9626566751093, 126.747719943523],
        [35.962645912271, 126.747662983527],
        [35.962543896985, 126.747123089669],
        [35.9624418817, 126.746583195811],
        [35.9623657632854, 126.746180355549],
        [35.962347531011, 126.746041447806],
        [35.9623266854961, 126.745882630348],
        [35.962301548688, 126.74549043814],
        [35.962266132876, 126.744937869749],
        [35.962230717064, 126.744385301357],
        [35.962195301252, 126.743832732966],
      ];
      const EVENT_ID = 1;
      const EVENT_DETAIL_ID = 1;
      const API_URL = "/api/v1/gpx/correct-location";
      const GPS_ERROR_METERS = 5;
      const INTERVAL_SECONDS = 10;

      // 2. 지도 초기화
      let map,
        userMarkers = {};
      function initMap() {
        map = L.map("map").setView(GPX_POINTS[0], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);
        L.polyline(GPX_POINTS, {
          color: "#2563eb",
          weight: 5,
          opacity: 0.8,
        }).addTo(map);
        L.marker(GPX_POINTS[0]).addTo(map).bindPopup("🏁 시작점").openPopup();
        L.marker(GPX_POINTS[GPX_POINTS.length - 1])
          .addTo(map)
          .bindPopup("🏁 도착점");
        map.fitBounds(L.polyline(GPX_POINTS).getBounds(), {
          padding: [20, 20],
        });
      }

      // Haversine 거리 계산 함수 (미터)
      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = (deg) => (deg * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(a));
      }

      // 3. GPS 데이터 생성 (10초 간격, 10m 오차, 유저별 속도/패턴)
      function generateUserGpsArrays() {
        // 유저별 속도(2.7~3.4 m/s) 랜덤 부여
        const userSpeeds = USERS.map(() => 2.7 + Math.random() * 0.7);
        return USERS.map((user, idx) => {
          let gpsArray = [];
          let totalTime = 0;
          for (let i = 0; i < GPX_POINTS.length - 1; i++) {
            const [lat1, lng1] = GPX_POINTS[i];
            const [lat2, lng2] = GPX_POINTS[i + 1];
            const dist = getDistance(lat1, lng1, lat2, lng2); // 미터
            let speed = userSpeeds[idx] + (Math.random() - 0.5) * 0.2; // 구간별 약간 랜덤
            let t = 0;
            while (t < dist) {
              const ratio = t / dist;
              const lat = lat1 + (lat2 - lat1) * ratio;
              const lng = lng1 + (lng2 - lng1) * ratio;
              // 10m 오차 적용
              const latErr =
                ((Math.random() - 0.5) * 2 * GPS_ERROR_METERS) / 111000;
              const lngErr =
                ((Math.random() - 0.5) * 2 * GPS_ERROR_METERS) /
                (111000 * Math.cos((lat * Math.PI) / 180));
              gpsArray.push({
                lat: lat + latErr,
                lng: lng + lngErr,
                altitude: 10.0,
                accuracy: 5.0,
                speed: speed,
                bearing: 180.0,
                timestamp: new Date(
                  Date.now() + totalTime * 1000
                ).toISOString(),
              });
              t += speed * INTERVAL_SECONDS;
              totalTime += INTERVAL_SECONDS;
            }
          }
          // 마지막 포인트 추가
          const [lat2, lng2] = GPX_POINTS[GPX_POINTS.length - 1];
          gpsArray.push({
            lat: lat2,
            lng: lng2,
            altitude: 10.0,
            accuracy: 5.0,
            speed: userSpeeds[idx],
            bearing: 180.0,
            timestamp: new Date(Date.now() + totalTime * 1000).toISOString(),
          });
          return { ...user, gpsArray, currentIdx: 0 };
        });
      }

      // 4. 10초마다 각 유저의 다음 포인트를 correct-location에 POST
      let simulationInterval = null;
      let userSimStates = [];
      function startSimulation() {
        if (simulationInterval) {
          log("⚠️ 이미 실행 중입니다.");
          return;
        }
        userSimStates = generateUserGpsArrays();
        // 마커 초기화
        userMarkers = {};
        userSimStates.forEach((user) => {
          const pt = user.gpsArray[0];
          const marker = L.circleMarker([pt.lat, pt.lng], {
            color: user.color,
            fillColor: user.color,
            fillOpacity: 0.9,
            radius: 10,
          })
            .addTo(map)
            .bindPopup(`${user.name}`);
          userMarkers[user.userId] = marker;
        });
        log("🚀 시뮬레이션 시작");
        simulationInterval = setInterval(
          sendNextGpsPoints,
          INTERVAL_SECONDS * 1000
        );
        sendNextGpsPoints(); // 즉시 1회 실행
      }
      function stopSimulation() {
        if (simulationInterval) {
          clearInterval(simulationInterval);
          simulationInterval = null;
          log("⏹️ 시뮬레이션 중지");
        }
      }
      async function sendNextGpsPoints() {
        for (const user of userSimStates) {
          if (user.currentIdx >= user.gpsArray.length) continue;
          const gpsPoint = user.gpsArray[user.currentIdx];
          // 마커 이동
          if (userMarkers[user.userId]) {
            userMarkers[user.userId].setLatLng([gpsPoint.lat, gpsPoint.lng]);
          }
          // correct-location POST
          const reqBody = {
            userId: user.userId,
            eventId: EVENT_ID,
            eventDetailId: EVENT_DETAIL_ID,
            gpsData: [gpsPoint],
          };
          log(
            `📤 <b>${user.name}</b> 요청:<br><pre>${JSON.stringify(
              reqBody,
              null,
              2
            )}</pre>`
          );
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(reqBody),
            });
            const resText = await res.text();
            log(
              `📥 <b>${user.name}</b> 응답: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
            );
          } catch (e) {
            log(`❌ <b>${user.name}</b> 전송 오류: ${e.message}`);
          }
          user.currentIdx++;
        }
      }

      // 5. 로그 함수 (크게, 최근이 맨 위)
      function log(msg) {
        const logArea = document.getElementById("logArea");
        const time = new Date().toLocaleTimeString();
        const entry = `<div style="margin-bottom:18px;"><span style="font-weight:bold;color:#60a5fa;">[${time}]</span> ${msg}</div>`;
        logArea.innerHTML = entry + logArea.innerHTML;
      }

      // 6. 초기 설정 API 호출 함수들
      async function createTestEvent() {
        log("🏃 테스트 이벤트 생성 중...");
        try {
          const url = `/api/v1/gpx/create-test-event?eventId=${EVENT_ID}&name=테스트 이벤트`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const resText = await res.text();
          log(
            `📥 <b>테스트 이벤트 생성</b> 응답: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log("✅ 테스트 이벤트 생성 완료!");
          }
        } catch (e) {
          log(`❌ 테스트 이벤트 생성 오류: ${e.message}`);
        }
      }

      async function createTestCourse() {
        log("🏁 테스트 코스 생성 중...");
        try {
          const url = `/api/v1/gpx/create-test-course?eventId=${EVENT_ID}&courseName=테스트 코스`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const resText = await res.text();
          log(
            `📥 <b>테스트 코스 생성</b> 응답: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log("✅ 테스트 코스 생성 완료!");
          }
        } catch (e) {
          log(`❌ 테스트 코스 생성 오류: ${e.message}`);
        }
      }

      async function uploadTestGpx() {
        log("📂 GPX 파일 업로드 중...");

        // GPX 포인트를 GPX 형식 문자열로 변환
        const gpxContent = generateGpxContent();

        // FormData로 파일 업로드 준비
        const formData = new FormData();
        const gpxBlob = new Blob([gpxContent], { type: "application/gpx+xml" });
        formData.append("file", gpxBlob, "test_route.gpx");
        formData.append("eventId", EVENT_ID);
        formData.append("userId", "1");
        formData.append("eventDetailId", EVENT_DETAIL_ID);
        formData.append("routeName", "테스트 경로");
        formData.append("description", "GPS 시뮬레이션용 테스트 경로");

        try {
          const res = await fetch("/api/v1/gpx/upload-gpx", {
            method: "POST",
            body: formData,
          });
          const resText = await res.text();
          log(
            `📥 <b>GPX 업로드</b> 응답: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log("✅ GPX 파일 업로드 완료!");
            // 업로드 성공 후 GPX 데이터 다시 로드
            await loadGpxPointsFromApi();
          }
        } catch (e) {
          log(`❌ GPX 업로드 오류: ${e.message}`);
        }
      }

      async function createTestParticipants() {
        log("👥 테스트 참가자 생성 중...");

        // 생성할 참가자 수 (기본 50명, 최대 1000명)
        const participantCount = 50;

        const requestBody = {
          eventId: EVENT_ID,
          eventDetailId: EVENT_DETAIL_ID,
          count: participantCount,
        };

        log(
          `📤 참가자 생성 요청: <pre>${JSON.stringify(
            requestBody,
            null,
            2
          )}</pre>`
        );

        try {
          const res = await fetch("/api/participants/test/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });
          const resText = await res.text();
          log(
            `📥 <b>테스트 참가자 생성</b> 응답: <b>${res.status} ${res.statusText}</b><br><pre>${resText}</pre>`
          );
          if (res.ok) {
            log(`✅ 테스트 참가자 ${participantCount}명 생성 완료!`);
          }
        } catch (e) {
          log(`❌ 테스트 참가자 생성 오류: ${e.message}`);
        }
      }

      // API에서 GPX 파싱 데이터 로드
      async function loadGpxPointsFromApi() {
        log("📡 Redis에서 GPX 데이터 로드 중...");

        try {
          const res = await fetch(
            `/api/v1/gpx/redis/${EVENT_ID}/${EVENT_DETAIL_ID}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const result = await res.json();
          log(
            `📡 <b>GPX 데이터 로드</b> 응답: <b>${res.status} ${res.statusText}</b>`
          );

          if (
            res.ok &&
            result.data &&
            result.data.success &&
            result.data.points
          ) {
            const points = result.data.points;
            log(`✅ GPX 데이터 로드 성공! (${points.length}개 포인트)`);

            // GPX_POINTS 배열 업데이트
            GPX_POINTS = points.map((point) => [
              point.latitude,
              point.longitude,
            ]);
            log(
              `🔄 GPX_POINTS 업데이트 완료 (처음 3개: ${JSON.stringify(
                GPX_POINTS.slice(0, 3)
              )})`
            );

            // 지도 업데이트
            updateMapWithNewPoints();

            return true;
          } else {
            log("⚠️ GPX 데이터가 없습니다. 먼저 GPX 파일을 업로드해주세요.");
            return false;
          }
        } catch (e) {
          log(`❌ GPX 데이터 로드 오류: ${e.message}`);
          return false;
        }
      }

      // 지도에 새로운 GPX 포인트 적용
      function updateMapWithNewPoints() {
        try {
          // 기존 GPX 경로 레이어 제거
          map.eachLayer(function (layer) {
            if (
              layer instanceof L.Polyline &&
              layer.options.color === "#2563eb"
            ) {
              map.removeLayer(layer);
            }
          });

          // 새로운 GPX 경로 추가
          L.polyline(GPX_POINTS, {
            color: "#2563eb",
            weight: 5,
            opacity: 0.7,
          }).addTo(map);

          // 지도 뷰 조정
          if (GPX_POINTS.length > 0) {
            const bounds = L.latLngBounds(GPX_POINTS);
            map.fitBounds(bounds, { padding: [20, 20] });
          }

          log("🗺️ 지도 업데이트 완료");
        } catch (e) {
          log(`❌ 지도 업데이트 오류: ${e.message}`);
        }
      }

      // GPX 형식 문자열 생성 함수
      function generateGpxContent() {
        let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPS 시뮬레이션" 
     xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd"
     xmlns="http://www.topografix.com/GPX/1/1" 
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <metadata>
    <name>테스트 루트</name>
    <desc>GPS 시뮬레이션용 테스트 경로</desc>
  </metadata>
  <trk>
    <name>Test Route</name>
    <trkseg>
`;

        GPX_POINTS.forEach((point, index) => {
          gpxContent += `      <trkpt lat="${point[0]}" lon="${point[1]}">
        <ele>10.0</ele>
        <time>${new Date(Date.now() + index * 1000).toISOString()}</time>
      </trkpt>
`;
        });

        gpxContent += `    </trkseg>
  </trk>
</gpx>`;

        return gpxContent;
      }

      // 7. 버튼 이벤트
      document.getElementById("createEventBtn").onclick = createTestEvent;
      document.getElementById("createCourseBtn").onclick = createTestCourse;
      document.getElementById("uploadGpxBtn").onclick = uploadTestGpx;
      document.getElementById("loadGpxBtn").onclick = loadGpxPointsFromApi;
      document.getElementById("createParticipantsBtn").onclick =
        createTestParticipants;
      document.getElementById("startBtn").onclick = startSimulation;
      document.getElementById("stopBtn").onclick = stopSimulation;

      // 8. 초기화
      window.onload = async function () {
        initMap();
        log("🚀 GPS 시뮬레이션 초기화 완료");

        // 페이지 로드 시 자동으로 GPX 데이터 로드 시도
        log("🔄 기존 GPX 데이터 자동 로드 중...");
        const loaded = await loadGpxPointsFromApi();
        if (!loaded) {
          log(
            "📌 GPX 데이터가 없습니다. 설정 버튼을 순서대로 클릭하여 테스트 환경을 준비하세요."
          );
        }
      };
    </script>
  </body>
</html>
